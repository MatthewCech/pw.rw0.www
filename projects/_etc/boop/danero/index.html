<!DOCTYPE html>
<html>
	<head>
		<!-- meta tags -->
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<!-- external links -->
		<script type="text/javascript" src="phaser.min.js"></script>

		<title>Plz Boop</title>
	</head>
	<style type="text/css">
	body {
		margin: 0px;
		padding: 0px;
	}
	</style>
	<body>
		<script>

          ///////////////////
         // Create Levels //
        ///////////////////
        // Main level
        class Level1 extends Phaser.State {
            // Variables

            // ===== Phaser Functions ===== //
            // First call for constructor.
            constructor(game){ super(game); 

                // Actual ctor content here.
                this.emitter = null;
                this.main_button = null;
                this.particle_life = 5000;
                this.sound_made = [];
                this.offset = false;
                this.delay = 30;
                this.last_click_time = 0;
                this.to_destroy = [];
            }

            // Configuration goes here. This is called first after construction.
            preload() {
                game.load.image('icon', 'icon.png');
                game.load.image('particle', 'particle.png');
                game.load.audio('sfx', 'boop.mp3');
                game.load.audio('sfx_up', 'boop_up.mp3');
            }
              
            // Put things to be regularly initialized once here. 
            create() {
                // Setup
                game.stage.backgroundColor = "#939294";
                this.main_button = game.add.sprite(game.width/2, game.height/2, 'icon');
                this.main_button.anchor.setTo(.5, .5);
                this.main_button.x_original = this.main_button.x;
                this.main_button.y_original = this.main_button.y;
                this.main_button.inputEnabled = true;
                this.main_button.events.onInputDown.add(function() {
                	this.offset = true;
	                this.emitter.x = this.main_button.x;
	                this.emitter.y = this.main_button.y;
	                this.emitter.start(true, this.particle_life, null, Math.floor(Math.random() * 20) + 10);
	                let noise = game.add.audio('sfx');
	                noise.delay = 0;
					this.last_click_time = (new Date()).getTime();
	                this.sound_made.push(noise);
                }, this);

                // Particle emitter setup
                game.physics.startSystem(Phaser.Physics.ARCADE);
                this.emitter = game.add.emitter(this.main_button.x, this.main_button.y, 400);
                this.emitter.gravity = 0;
                this.emitter.minParticleScale = .01;
                this.emitter.maxParticleScale = .25;
                this.emitter.minParticleSpeed.x = -300;
                this.emitter.minParticleSpeed.y = -300;
                this.emitter.maxParticleSpeed.x = 300;
                this.emitter.maxParticleSpeed.y = 300;
                this.emitter.setAlpha(1, 0, this.particle_life);
                this.emitter.makeParticles('particle');

                // Handle button up.
                game.input.activePointer.leftButton.onUp.add(function() {
                	if(this.offset == true) {
	                	let noise = game.add.audio('sfx_up');
	                	let difference = (new Date()).getTime() - this.last_click_time;
	                	if(difference < 60)
							noise.delay = 60 - difference;
						else
							noise.delay = 0;
		                this.sound_made.push(noise);
		            }	
                	this.offset = false;
                }, this);
            }

            update() {
            	// Keep the button on top.
            	game.world.bringToTop(this.main_button);

            	// Play sounds when delay is up.
            	for(let i = 0; i < this.sound_made.length;) {
            		if(this.sound_made[i].delay > 0) {
            			this.sound_made[i].delay -= 1;
            			++i;
            		}
            		else {
            			this.sound_made[i].play();
            			this.to_destroy.push(this.sound_made[i]);
            			this.sound_made.splice(i, 1);
            		}
            	}

            	// Clean up used sounds.
            	for(let i = 0; i < this.to_destroy.length;) {
            		if(this.to_destroy[i].isPlaying) {
            			++i;
            		} else {
            			this.to_destroy[i].destroy();
            			// this line should work alone, but does not work. So I increment i after.
            			this.sound_made.splice(i, 1);
            			++i;
            		}
            	}

            	// Handle button offset as necessary.
            	if(this.offset) {
            		this.main_button.x = this.main_button.x_original + 2;
            		this.main_button.y = this.main_button.y_original + 2;
            	} else {
            		this.main_button.x = this.main_button.x_original - 2;
            		this.main_button.y = this.main_button.y_original - 2;
            	}
            }
        }

          //////////////////
         // Phaser Setup //
        //////////////////
        // Get game object and add levels. Note: This must come last.
        // Note: Consider scaling by window.devicePixelRatio.
        var game = new Phaser.Game(window.innerWidth, window.innerHeight, Phaser.AUTO, '');  // Initialize the phaser window
        game.state.add('level_main', new Level1(game));                                      // Add your levels like this.
        game.state.start('level_main');                                                      // Dictates starting "Level".
		</script>
	</body>
</html>
